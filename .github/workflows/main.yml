name: Build Android Phira

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always
  ANDROID_HOME: ${{ github.workspace }}/android-sdk
  ANDROID_NDK_HOME: ${{ github.workspace }}/android-ndk
  ANDROID_NDK_ROOT: ${{ github.workspace }}/android-ndk

jobs:
  Build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          curl \
          wget \
          unzip \
          zip \
          openjdk-11-jdk \
          pkg-config \
          libssl-dev
        
    - name: Download static-lib
      uses: suisei-cn/actions-download-file@v1.3.0
      with:
        url: "https://teamflos.github.io/phira-docs/phira_build_guide/prpr-avc.zip"
        target: ./

    - name: Extract static-lib
      run: |
        unzip -q prpr-avc.zip -d ./

    - name: Setup Android SDK
      run: |
        # 创建目录结构
        mkdir -p $ANDROID_HOME/cmdline-tools/latest
        
        # 下载命令行工具
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip
        
        # 直接解压到正确的位置
        unzip -q commandlinetools-linux-8512546_latest.zip -d $ANDROID_HOME/cmdline-tools/latest/
        
        # 移动内容到正确位置（如果需要）
        mv $ANDROID_HOME/cmdline-tools/latest/cmdline-tools/* $ANDROID_HOME/cmdline-tools/latest/
        rm -rf $ANDROID_HOME/cmdline-tools/latest/cmdline-tools
        
        # 验证安装
        echo "=== SDK Manager List ==="
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list --sdk_root=$ANDROID_HOME || true
        
        # 安装必要的组件
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_HOME \
          "platform-tools" \
          "build-tools;33.0.2" \
          "platforms;android-35" \
          "ndk;25.1.8937393"

    - name: Setup Android NDK (使用 SDK Manager 安装的版本)
      run: |
        # 设置使用 SDK Manager 安装的 NDK
        SDK_NDK_PATH="$ANDROID_HOME/ndk/25.1.8937393"
        echo "ANDROID_NDK_HOME=$SDK_NDK_PATH" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$SDK_NDK_PATH" >> $GITHUB_ENV
        echo "NDK_HOME=$SDK_NDK_PATH" >> $GITHUB_ENV
        
        # 验证 NDK 安装
        echo "=== NDK Contents ==="
        ls -la $SDK_NDK_PATH

    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        targets: aarch64-linux-android
        override: true

    - name: Install cargo-ndk
      run: |
        cargo install cargo-ndk --version 2.8.0

    - name: Configure Cargo for Android
      run: |
        # 创建 Cargo 配置目录
        mkdir -p ~/.cargo
        
        # 配置 Android 链接器
        cat >> ~/.cargo/config.toml << EOF
        [target.aarch64-linux-android]
        linker = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android33-clang"
        ar = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
        EOF

    - name: Build for Android
      run: |
        cd phira
        echo "=== Starting Android Build ==="
        echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
        echo "ANDROID_HOME: $ANDROID_HOME"
        
        # 使用 cargo-ndk 构建
        cargo ndk -t arm64-v8a -p 35 build --release --verbose
      env:
        CC_aarch64_linux_android: "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android33-clang"
        CXX_aarch64_linux_android: "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android33-clang++"
        AR_aarch64_linux_android: "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-build
        path: |
          target/aarch64-linux-android/release/libphira.so
        retention-days: 7
